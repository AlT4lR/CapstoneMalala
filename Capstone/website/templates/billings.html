{% extends "base.html" %}
{% block title %}DecoOffice Billings{% endblock %}

{% block head %}
<style>
    /* Custom style for the active week button to match the new design */
    .week-btn.active {
        background-color: #3a4d39;
        color: white;
        font-weight: 600;
        border-color: #3a4d39;
    }
</style>
{% endblock %}

{% block content %}
<main class="flex-1 p-4 sm:p-6 flex flex-col gap-4 bg-[#f6f7f1] text-[#3a4d39]">
    
    <!-- Header -->
    <header class="flex justify-between items-center border-b border-[#d4d8c4] pb-2">
        <h1 class="text-2xl font-bold">Billings</h1>
        <div class="flex items-center gap-4">
            <a href="{{ url_for('main.archive', back=request.path) }}" class="text-gray-500 hover:text-[#3a4d39]" title="Archive"><i class="fa-solid fa-box-archive fa-lg"></i></a>
            {% include "_notification_button.html" %}
        </div>
    </header>

    <!-- --- START OF MODIFICATION: Redesigned Summary of Billings Section --- -->
    <section class="bg-white rounded-lg shadow-sm border border-[#e1e4d5] p-6">
        <h2 class="text-lg font-bold mb-4">Summary of Billings</h2>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <!-- Left Side: Month/Week Selector -->
            <div class="flex flex-col items-center justify-center p-4">
                <div class="flex justify-between items-center w-full max-w-xs mb-6">
                    <button id="prev-month-btn" class="hover:bg-gray-200 rounded-full p-2 transition-colors"><i class="fa-solid fa-chevron-left"></i></button>
                    <span id="billing-month-year" class="font-bold text-xl tracking-wider">OCTOBER 2025</span>
                    <button id="next-month-btn" class="hover:bg-gray-200 rounded-full p-2 transition-colors"><i class="fa-solid fa-chevron-right"></i></button>
                </div>
                <div id="week-buttons-container" class="w-full max-w-xs space-y-4">
                    <!-- Week buttons will be dynamically generated by JavaScript -->
                </div>
            </div>

            <!-- Right Side: Summary Display Cards -->
            <div class="space-y-4">
                <!-- Card 1 -->
                <div class="flex flex-col">
                    <div class="bg-white border border-gray-300 rounded-md px-4 py-2 text-gray-700 z-10 w-fit">Countered Check</div>
                    <div id="summary-countered-check" class="bg-[#3a4d39] text-white rounded-lg p-4 -mt-2 h-24 flex items-center justify-end text-3xl font-mono font-bold">
                        ₱0.00
                    </div>
                </div>
                <!-- Card 2 -->
                <div class="flex flex-col">
                    <div class="bg-white border border-gray-300 rounded-md px-4 py-2 text-gray-700 z-10 w-fit">Total EWT Collected</div>
                    <div id="summary-ewt" class="bg-[#3a4d39] text-white rounded-lg p-4 -mt-2 h-24 flex items-center justify-end text-3xl font-mono font-bold">
                        ₱0.00
                    </div>
                </div>
                <!-- Card 3 -->
                <div class="flex flex-col">
                    <div class="bg-white border border-gray-300 rounded-md px-4 py-2 text-gray-700 z-10 w-fit">Total Check Amount</div>
                    <div id="summary-check-amount" class="bg-[#3a4d39] text-white rounded-lg p-4 -mt-2 h-24 flex items-center justify-end text-3xl font-mono font-bold">
                        ₱0.00
                    </div>
                </div>
            </div>

        </div>
    </section>
    <!-- --- END OF MODIFICATION --- -->

    <!-- --- START OF MODIFICATION: Loans section is now completely removed --- -->
    <!-- The entire <section> for loans has been deleted. -->
    <!-- The modal for "Create Loan" has also been deleted. -->
    <!-- --- END OF MODIFICATION --- -->

</main>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const monthYearDisplay = document.getElementById('billing-month-year');
    const prevMonthBtn = document.getElementById('prev-month-btn');
    const nextMonthBtn = document.getElementById('next-month-btn');
    const weekButtonsContainer = document.getElementById('week-buttons-container');

    // --- START OF MODIFICATION: New summary element references ---
    const summaryCounteredCheckEl = document.getElementById('summary-countered-check');
    const summaryEwtEl = document.getElementById('summary-ewt');
    const summaryCheckAmountEl = document.getElementById('summary-check-amount');
    // --- END OF MODIFICATION ---

    const now = new Date();
    // Initialize to the 1st of the current month (UTC to avoid local time zone issues)
    let currentDate = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), 1));
    let currentWeek;

    const currencyFormatter = new Intl.NumberFormat('en-PH', { style: 'currency', currency: 'PHP' });

    function getWeekNumber(d) {
        // Copy date so don't modify original
        d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        // Set to nearest Thursday: current date + 4 - current day number (adjusting for Sunday = 0)
        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
        // Get first day of year
        var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
        // Calculate full weeks to determine week number
        var weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        return weekNo;
    }

    async function updateBillingSummary(year, week) {
        // --- START OF MODIFICATION: Update new summary elements ---
        summaryCounteredCheckEl.textContent = '...';
        summaryEwtEl.textContent = '...';
        summaryCheckAmountEl.textContent = '...';
        // --- END OF MODIFICATION ---
        
        try {
            const response = await fetch(`/api/billings/summary?year=${year}&week=${week}`);
            if (!response.ok) throw new Error('Network response was not ok');
            const data = await response.json();
            
            // --- START OF MODIFICATION: Populate the new summary cards ---
            summaryCounteredCheckEl.textContent = currencyFormatter.format(data.countered_check || 0);
            summaryEwtEl.textContent = currencyFormatter.format(data.ewt_collected || 0);
            summaryCheckAmountEl.textContent = currencyFormatter.format(data.check_amount || 0);
            // --- END OF MODIFICATION ---

        } catch (error) {
            console.error('Failed to fetch billing summary:', error);
            // --- START OF MODIFICATION: Update new elements on error ---
            summaryCounteredCheckEl.textContent = 'Error';
            summaryEwtEl.textContent = 'Error';
            summaryCheckAmountEl.textContent = 'Error';
            // --- END OF MODIFICATION ---
        }

        // Update active button style
        weekButtonsContainer.querySelectorAll('.week-btn').forEach(btn => {
            btn.classList.remove('active');
            if (parseInt(btn.dataset.weekIndex) === week) {
                btn.classList.add('active');
            }
        });
    }

    function renderControls() {
        const year = currentDate.getUTCFullYear();
        const month = currentDate.getUTCMonth();
        const monthName = currentDate.toLocaleString('default', { month: 'long', timeZone: 'UTC' }).toUpperCase();
        
        monthYearDisplay.textContent = `${monthName} ${year}`;
        weekButtonsContainer.innerHTML = '';

        const firstDayOfMonth = new Date(Date.UTC(year, month, 1));
        const startWeekNum = getWeekNumber(firstDayOfMonth);

        const today = new Date();
        let activeWeekNum;
        
        // If the current month is the month being displayed, set active week to today's week
        if (today.getUTCFullYear() === year && today.getUTCMonth() === month) {
             activeWeekNum = getWeekNumber(today);
             // Safety check: ensure today's week falls within the expected range for the month's UI
             if (activeWeekNum < startWeekNum || activeWeekNum >= startWeekNum + 5) {
                 activeWeekNum = startWeekNum;
             }
        } else {
            // Otherwise, default to the week the 1st of the month falls into
            activeWeekNum = startWeekNum;
        }

        // Loop to generate a maximum of 5 buttons (to cover most months fully)
        for (let i = 0; i < 5; i++) { 
            const weekNum = startWeekNum + i;
            
            // Safety break for unexpected year-end roll-overs
            if (weekNum > 53 && i > 1) break; 
            
            const button = document.createElement('button');
            button.dataset.weekIndex = weekNum;
            
            // --- FIX: Change label back to 'Week ${i + 1}' ---
            button.textContent = `Week ${i + 1}`; 
            // --- END FIX ---
            
            button.className = 'week-btn w-full px-4 py-3 bg-white border border-gray-300 rounded-lg text-center font-medium hover:border-[#3a4d39] transition-colors';
            weekButtonsContainer.appendChild(button);
        }
        
        currentWeek = activeWeekNum;
        updateBillingSummary(year, currentWeek);
    }

    prevMonthBtn.addEventListener('click', () => {
        currentDate.setUTCMonth(currentDate.getUTCMonth() - 1);
        renderControls();
    });

    nextMonthBtn.addEventListener('click', () => {
        currentDate.setUTCMonth(currentDate.getUTCMonth() + 1);
        renderControls();
    });

    weekButtonsContainer.addEventListener('click', (e) => {
        if (e.target.matches('.week-btn')) {
            currentWeek = parseInt(e.target.dataset.weekIndex);
            updateBillingSummary(currentDate.getUTCFullYear(), currentWeek);
        }
    });
    
    // Initial render
    renderControls();

});
</script>
{% endblock %}