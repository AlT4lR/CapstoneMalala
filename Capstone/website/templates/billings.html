{% extends "base.html" %}
{% block title %}DecoOffice Billings{% endblock %}
{% block content %}
<main class="flex-1 p-4 sm:p-6 flex flex-col gap-4 bg-[#f6f7f1] text-[#3a4d39]">

    <!-- Header -->
    <header class="flex justify-between items-center border-b border-[#cdd5c9] pb-2">
        <h1 class="text-2xl font-bold">Billings</h1>
        <div class="flex items-center gap-4">
            <a href="{{ url_for('main.archive', back=request.path) }}" class="text-gray-500 hover:text-[#3a4d39]" title="Archive"><i class="fa-solid fa-box-archive fa-lg"></i></a>
            {% include "_notification_button.html" %}
        </div>
    </header>

    <!-- Summary of Billings -->
    <section class="bg-white rounded-xl border border-[#e1e4d5] shadow-sm p-4">
        <h2 class="text-lg font-bold mb-3">Summary of Billings</h2>
        <div class="grid md:grid-cols-2 gap-4">

            <!-- Weeks and Month Navigation -->
            <div class="bg-[#3a4d39] p-4 rounded-xl flex flex-col gap-3 justify-center text-white">
                <div class="flex justify-between items-center">
                    <button id="prev-month-btn" class="px-3 py-1 rounded-lg bg-transparent hover:bg-white/10">
                        <i class="fa-solid fa-chevron-left"></i>
                    </button>
                    <h3 id="billing-month-year" class="font-semibold tracking-wider">OCTOBER 2025</h3>
                    <button id="next-month-btn" class="px-3 py-1 rounded-lg bg-transparent hover:bg-white/10">
                        <i class="fa-solid fa-chevron-right"></i>
                    </button>
                </div>

                <div id="week-buttons-container" class="grid grid-cols-2 gap-3">
                    <!-- Week buttons are generated by JS -->
                </div>
            </div>

            <!-- Summary Cards -->
            <div class="grid grid-cols-2 gap-3">
                 <div class="flex flex-col gap-2">
                    <div class="bg-white border border-gray-300 rounded-lg p-2 text-center text-sm font-semibold underline">Check Amount</div>
                    <div id="total-check-amount" class="bg-[#3a4d39] text-white rounded-lg flex-1 flex items-center justify-center text-xl font-bold">₱0.00</div>
                </div>
                <div class="flex flex-col gap-2">
                    <div class="bg-white border border-gray-300 rounded-lg p-2 text-center text-sm font-semibold underline">Total EWT Collected</div>
                    <div id="total-ewt" class="bg-[#3a4d39] text-white rounded-lg flex-1 flex items-center justify-center text-xl font-bold">₱0.00</div>
                </div>
                <div class="flex flex-col gap-2">
                    <div class="bg-white border border-gray-300 rounded-lg p-2 text-center text-sm font-semibold underline">Countered Check</div>
                    <div id="total-countered-check" class="bg-[#3a4d39] text-white rounded-lg flex-1 flex items-center justify-center text-xl font-bold">₱0.00</div>
                </div>
                <div class="flex flex-col gap-2">
                    <div class="bg-white border border-gray-300 rounded-lg p-2 text-center text-sm font-semibold underline">Total amt of other loans</div>
                    <div id="total-loans" class="bg-[#3a4d39] text-white rounded-lg flex-1 flex items-center justify-center text-xl font-bold">₱0.00</div>
                </div>
            </div>
        </div>
    </section>

    <!-- Loans Section -->
    <section class="bg-white rounded-xl border border-[#e1e4d5] shadow-sm p-4 flex flex-col">
        <h2 class="text-lg font-bold mb-3">Loans</h2>

        <div class="overflow-hidden rounded-lg border">
             <div class="max-h-[14.5rem] overflow-y-auto custom-scrollbar">
                <table class="min-w-full border-collapse">
                    <thead class="bg-[#3a4d39] text-white sticky top-0 z-10">
                        <tr>
                            <th class="px-4 py-2 text-left font-semibold text-sm">Name Of Loans</th>
                            <th class="px-4 py-2 text-left font-semibold text-sm">Bank Name</th>
                            <th class="px-4 py-2 text-left font-semibold text-sm">Amount</th>
                            <th class="px-4 py-2 text-left font-semibold text-sm">Date Issued</th>
                            <th class="px-4 py-2 text-left font-semibold text-sm">Date Paid</th>
                            <th class="px-4 py-2 text-right">
                                <div class="relative">
                                    <input type="text" id="loan-search-input" placeholder="Search loans..."
                                        class="w-32 sm:w-40 pl-8 pr-2 py-1 bg-white/20 placeholder-white/70 rounded-md text-sm focus:outline-none focus:bg-white/30">
                                    <i class="fa-solid fa-search absolute left-2.5 top-1/2 -translate-y-1/2 text-white/70"></i>
                                </div>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="loans-table-body" class="bg-white text-gray-800 text-sm">
                        {% if loans %}
                            {% for loan in loans %}
                                <tr class="border-b border-gray-200 hover:bg-gray-50 transition-colors">
                                    <td class="px-4 py-2 font-medium">{{ loan.name }}</td>
                                    <td class="px-4 py-2 text-gray-600">{{ loan.bank_name }}</td>
                                    <td class="px-4 py-2 text-gray-600">₱{{ "{:,.2f}".format(loan.amount) }}</td>
                                    <td class="px-4 py-2 text-gray-600">{{ loan.date_issued.strftime('%m/%d/%Y') if loan.date_issued else 'N/A' }}</td>
                                    <td class="px-4 py-2 text-gray-600">{{ loan.date_paid.strftime('%m/%d/%Y') if loan.date_paid else '-' }}</td>
                                    <td class="px-4 py-2 text-right text-gray-400">
                                        <button class="hover:text-[#3a4d39]"><i class="fa-solid fa-pen-to-square"></i></button>
                                    </td>
                                </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="6" class="text-center py-8 text-gray-500">No loans have been created yet.</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Create Loan Button -->
        <div class="flex justify-end mt-4">
            <button id="create-loan-btn"
                class="bg-[#3a4d39] text-white px-6 py-2.5 rounded-lg shadow-sm hover:bg-opacity-90 transition">
                Create Loan
            </button>
        </div>
    </section>

    <!-- Create Loan Modal -->
    <div id="add-loan-modal" class="modal-backdrop hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
        <div class="modal-content bg-[#fafaf5] rounded-xl shadow-2xl w-full max-w-lg p-8 relative text-gray-700">
            <button id="close-loan-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button>
             <h2 class="text-xl font-bold text-[#3a4d39] mb-6">Add New Loan</h2>
            <form id="add-loan-form" method="POST" class="space-y-4" novalidate>
                {{ form.hidden_tag() }}
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold mb-1">Name Of Loans</label>
                        <input type="text" name="name_of_loan" class="w-full px-4 py-2 bg-white border border-gray-300 rounded-lg" required>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1">Bank Name</label>
                        <input type="text" name="bank_name" class="w-full px-4 py-2 bg-white border border-gray-300 rounded-lg" required>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1">Date Issued</label>
                        <input type="date" name="date_issued" class="w-full px-4 py-2 bg-white border border-gray-300 rounded-lg" required>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1">Date Paid</label>
                        <input type="date" name="date_paid" class="w-full px-4 py-2 bg-white border border-gray-300 rounded-lg">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-semibold mb-1">Amount</label>
                        <input type="number" step="0.01" name="amount" class="w-full px-4 py-2 bg-white border border-gray-300 rounded-lg" required>
                    </div>
                </div>
                <div class="flex justify-end pt-4 gap-3">
                    <button type="button" id="cancel-loan-btn" class="px-8 py-2.5 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-8 py-2.5 bg-[#3a4d39] text-white font-semibold rounded-lg shadow-md hover:bg-opacity-90">Add Loan</button>
                </div>
            </form>
        </div>
    </div>

</main>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Summary Logic ---
    const monthYearDisplay = document.getElementById('billing-month-year');
    const prevMonthBtn = document.getElementById('prev-month-btn');
    const nextMonthBtn = document.getElementById('next-month-btn');
    const weekButtonsContainer = document.getElementById('week-buttons-container');
    const totalCheckAmountEl = document.getElementById('total-check-amount');
    const totalEwtEl = document.getElementById('total-ewt');
    const totalCounteredCheckEl = document.getElementById('total-countered-check');
    const totalLoansEl = document.getElementById('total-loans');
    let currentDate = new Date();
    let currentWeek;
    const currencyFormatter = new Intl.NumberFormat('en-PH', { style: 'currency', currency: 'PHP' });

    function getWeekNumber(d) {
        d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
        var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
        return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    }

    async function updateBillingSummary(year, week) {
        try {
            const response = await fetch(`/api/billings/summary?year=${year}&week=${week}`);
            if (!response.ok) throw new Error('Network response was not ok');
            const data = await response.json();
            totalCheckAmountEl.textContent = currencyFormatter.format(data.check_amount || 0);
            totalEwtEl.textContent = currencyFormatter.format(data.ewt_collected || 0);
            totalCounteredCheckEl.textContent = currencyFormatter.format(data.countered_check || 0);
            totalLoansEl.textContent = currencyFormatter.format(data.other_loans || 0);
        } catch (error) {
            console.error('Failed to fetch billing summary:', error);
            [totalCheckAmountEl, totalEwtEl, totalCounteredCheckEl, totalLoansEl].forEach(el => el.textContent = 'Error');
        }
        weekButtonsContainer.querySelectorAll('.week-btn').forEach(btn => {
            btn.classList.remove('bg-[#5a7159]', 'border', 'border-white');
            btn.classList.add('bg-[#6b8f71]');
            if (parseInt(btn.dataset.weekIndex) === week) {
                btn.classList.add('bg-[#5a7159]', 'border', 'border-white');
            }
        });
    }

    function renderControls() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        monthYearDisplay.textContent = `${currentDate.toLocaleString('default', { month: 'long' }).toUpperCase()} ${year}`;
        weekButtonsContainer.innerHTML = '';
        const startWeekNum = getWeekNumber(new Date(year, month, 1));
        for (let i = 0; i < 4; i++) {
            const weekNum = startWeekNum + i;
            const button = document.createElement('button');
            button.dataset.weekIndex = weekNum;
            button.textContent = `WEEK ${i + 1}`;
            button.className = 'week-btn bg-[#6b8f71] hover:bg-[#5b7c61] py-2 rounded-lg font-semibold transition-colors';
            weekButtonsContainer.appendChild(button);
        }
        const today = new Date();
        currentWeek = (today.getFullYear() === year && today.getMonth() === month) ? getWeekNumber(today) : startWeekNum;
        updateBillingSummary(year, currentWeek);
    }

    prevMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderControls(); });
    nextMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderControls(); });
    weekButtonsContainer.addEventListener('click', e => {
        if (e.target.matches('.week-btn')) {
            currentWeek = parseInt(e.target.dataset.weekIndex);
            updateBillingSummary(currentDate.getFullYear(), currentWeek);
        }
    });
    
    renderControls();

    // --- Loan Modal & Form Logic ---
    const modal = document.getElementById('add-loan-modal');
    const openBtn = document.getElementById('create-loan-btn');
    const closeBtn = document.getElementById('close-loan-modal-btn');
    const cancelBtn = document.getElementById('cancel-loan-btn');
    const loanForm = document.getElementById('add-loan-form');
    
    const openModal = () => {
        loanForm.reset();
        modal.classList.remove('hidden');
        setTimeout(() => modal.classList.add('active'), 10);
    };
    const closeModal = () => {
        modal.classList.remove('active');
        modal.addEventListener('transitionend', () => modal.classList.add('hidden'), { once: true });
    };

    if (modal && openBtn && closeBtn && cancelBtn) {
        openBtn.addEventListener('click', openModal);
        closeBtn.addEventListener('click', closeModal);
        cancelBtn.addEventListener('click', closeModal);
        modal.addEventListener('click', (event) => { if (event.target === modal) closeModal(); });
    }

    if (loanForm) {
        loanForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            const submitButton = this.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = 'Adding...';
            try {
                const response = await fetch("{{ url_for('main.add_loan_route') }}", {
                    method: 'POST', body: new URLSearchParams(new FormData(this)).toString(),
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
                    }
                });
                if (response.ok) {
                    window.location.reload();
                } else {
                    alert('An error occurred. Please try again.');
                    submitButton.disabled = false; submitButton.textContent = 'Add Loan';
                }
            } catch (error) {
                console.error('Submission failed:', error);
                alert('A network error occurred. Please try again.');
                submitButton.disabled = false; submitButton.textContent = 'Add Loan';
            }
        });
    }

    // --- Loan Search Logic ---
    const searchInput = document.getElementById('loan-search-input');
    const tableBody = document.getElementById('loans-table-body');
    const allRows = tableBody.querySelectorAll('tr');

    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase().trim();
        allRows.forEach(row => {
            const rowText = row.textContent.toLowerCase();
            row.style.display = rowText.includes(searchTerm) ? '' : 'none';
        });
    });
});
</script>
{% endblock %}