<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>OTP Verification - DecoOffice</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <style>
        /* Custom styles for OTP inputs */
        .otp-input {
            width: 4rem;
            height: 4rem;
            text-align: center;
            font-size: 1.5rem;
            border: 1px solid #d3d6c4; /* Use a neutral border color */
            border-radius: 0.5rem;
            margin: 0 0.25rem;
            color: #2f4f2f; /* Use theme color */
            box-sizing: border-box;
            line-height: 1;
        }
        .otp-input:focus {
            outline: none;
            border-color: #4a6842; /* Use theme color */
            box-shadow: 0 0 0 2px rgba(74, 104, 66, 0.3); /* Use theme color */
        }
        /* Flash message animation */
        .flash-message-local {
            opacity: 1;
            transition: opacity 0.5s ease-out;
        }
        .flash-message-local.fade-out {
            opacity: 0;
        }
    </style>
    <script>
        // Tailwind configuration for standalone pages
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { poppins: ['Poppins', 'sans-serif'] },
                    colors: {
                        'custom-bg': '#f5f5f0',
                        'custom-sidebar': '#d7e0d3',
                        'custom-green-active': '#8aa188',
                        'custom-text-dark': '#3a3a3a',
                        'custom-green-darker': '#6f8a6e',
                        'custom-logo-text': '#f6f6e9',
                        'success-bg': '#d4edda', /* For flash messages */
                        'success-text': '#155724', /* For flash messages */
                        'success-border': '#c3e6cb', /* For flash messages */
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-custom-green-darker font-poppins antialiased">

    <!-- Header -->
    <header class="flex items-center justify-between p-5 text-white text-xl font-bold">
        <a href="{{ url_for('auth.login') }}" class="text-white opacity-70 hover:opacity-100 transition-colors">
            <i class="fas fa-chevron-left"></i>
            <span class="ml-2">DecoOffice</span>
        </a>
    </header>

    <main class="flex items-center justify-center" style="min-height: calc(100vh - 80px);">
        <!-- OTP Modal -->
        <div class="w-11/12 max-w-lg mx-auto bg-[#f6f6e9] rounded-xl overflow-hidden shadow-2xl p-8 text-center">
            
            <h1 class="text-custom-text-dark mb-4 text-2xl font-bold">Email Verification</h1>

            {# Flash messages are handled by the meta tag and common.js for AJAX, but can be rendered here for initial load #}
            <div id="flash-messages-container" class="mb-5 flash-message-local">
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="p-2.5 mb-4 rounded-md text-center text-white {{ 'bg-custom-green-active' if category == 'success' else 'bg-[#d9534f]' }}">
                                {{ message }}
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
            </div>

            <p class="text-gray-600 mb-6">
                Please enter the 6-digit verification code sent to your email to complete your account registration.
                <br>
                Do not share this code with anyone. It will expire in 10 minutes.
            </p>

            <form id="otp-form" action="{{ url_for('auth.verify_otp') }}" method="POST">
                {# This div contains the six individual input boxes #}
                <div class="flex justify-center mb-6" id="otp-inputs">
                    <input type="text" name="otp1" class="otp-input" maxlength="1" inputmode="numeric" pattern="[0-9]" required>
                    <input type="text" name="otp2" class="otp-input" maxlength="1" inputmode="numeric" pattern="[0-9]" required>
                    <input type="text" name="otp3" class="otp-input" maxlength="1" inputmode="numeric" pattern="[0-9]" required>
                    <input type="text" name="otp4" class="otp-input" maxlength="1" inputmode="numeric" pattern="[0-9]" required>
                    <input type="text" name="otp5" class="otp-input" maxlength="1" inputmode="numeric" pattern="[0-9]" required>
                    <input type="text" name="otp6" class="otp-input" maxlength="1" inputmode="numeric" pattern="[0-9]" required>
                </div>

                <div class="flex justify-between items-center text-sm text-gray-500 mb-8">
                    <div id="timer">Remaining Time: <span class="font-bold text-gray-700">10:00</span></div>
                    <div>Didn't get the code? <a href="{{ url_for('auth.resend_otp') }}" id="resend-link" class="font-bold text-custom-green-active hover:underline">Resend</a></div>
                </div>

                <div class="space-y-4">
                    <button type="submit" class="w-full bg-custom-green-active text-white border-none p-4 rounded-full font-bold cursor-pointer transition duration-200 shadow hover:bg-custom-green-darker hover:shadow-md">Verify</button>
                    <a href="{{ url_for('auth.login') }}" class="block w-full bg-transparent text-custom-text-dark border-2 border-custom-green-darker p-3.5 rounded-full font-bold cursor-pointer transition duration-200 hover:bg-custom-green-darker hover:border-custom-green-active">Cancel</a>
                </div>
            </form>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const inputs = document.getElementById('otp-inputs');
            const flashMessagesContainer = document.getElementById('flash-messages-container');
            
            inputs.addEventListener('input', function (e) {
                const target = e.target;
                const val = target.value;
                if (isNaN(val)) {
                    target.value = '';
                    return;
                }
                if (val != '') {
                    const next = target.nextElementSibling;
                    if (next && next.classList.contains('otp-input')) {
                        next.focus();
                    }
                }
            });

            inputs.addEventListener('keyup', function (e) {
                const target = e.target;
                const key = e.key.toLowerCase();

                if ((key == 'backspace' || key == 'delete') && target.value == '') {
                    const prev = target.previousElementSibling;
                    if (prev && prev.classList.contains('otp-input')) {
                        prev.focus();
                    }
                    return;
                }
            });

            // Timer logic
            const timerElement = document.querySelector('#timer span');
            let timeLeft = 600; // 10 minutes in seconds

            const timerInterval = setInterval(() => {
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    timerElement.textContent = "Expired";
                    // Consider disabling resend link or making it active again
                    return;
                }
                timeLeft--;
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);

            // Auto-fade for flash messages
            if (flashMessagesContainer) {
                setTimeout(() => {
                    flashMessagesContainer.classList.add('fade-out');
                    flashMessagesContainer.addEventListener('transitionend', () => {
                        flashMessagesContainer.remove();
                    });
                }, 5000);
            }
        });
    </script>
</body>
</html>