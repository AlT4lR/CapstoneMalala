{% extends "base.html" %}
{% block title %}DecoOffice - Settings{% endblock %}
{% block content %}
<main class="flex-1 p-4 sm:p-6 lg:p-8 bg-[#f6f7f1]">

    <header class="flex justify-between items-center mb-6 border-b border-[#d4d8c4] pb-3">
        <h2 class="text-2xl font-semibold text-[#3a4d39] uppercase tracking-wide">Settings</h2>
        <div class="flex items-center gap-3">
             {% include "_notification_button.html" %}
        </div>
    </header>

    <div class="max-w-4xl mx-auto space-y-6">

        <div class="bg-white rounded-lg shadow-sm border border-[#e1e4d5] p-5 sm:p-6">
            <h3 class="text-lg font-bold text-[#3a4d39] border-b border-gray-200 pb-3 mb-4">General</h3>
            
            <div class="flex flex-col sm:flex-row items-center justify-between p-3 rounded-lg hover:bg-gray-50 transition-colors">
                <div>
                    <p class="font-semibold text-gray-800">Change Branch</p>
                    <p class="text-sm text-gray-500 mt-1 sm:mt-0">Switch between your assigned Montalban and Laguna branches.</p>
                </div>
                <a href="{{ url_for('main.change_branch') }}" 
                   class="w-full sm:w-auto mt-3 sm:mt-0 px-6 py-2 bg-[#3a4d39] text-white text-center font-semibold rounded-lg shadow-sm hover:bg-opacity-90 transition-colors">
                    Switch
                </a>
            </div>

            <div class="border-t flex flex-col sm:flex-row items-center justify-between p-3 rounded-lg hover:bg-gray-50 transition-colors">
                <div>
                    <p class="font-semibold text-gray-800">Install App</p>
                    <p class="text-sm text-gray-500 mt-1 sm:mt-0">Add DecoOffice to your home screen for a better experience.</p>
                </div>
                <button id="custom-install-button" style="display: none;"
                    class="w-full sm:w-auto mt-3 sm:mt-0 px-6 py-2 bg-[#3a4d39] text-white text-center font-semibold rounded-lg shadow-sm hover:bg-opacity-90 transition-colors">
                    Install
                </button>
            </div>

             <div class="border-t flex flex-col sm:flex-row items-center justify-between p-3 rounded-lg hover:bg-gray-50 transition-colors">
                <div>
                    <p class="font-semibold text-gray-800">Enable Push Notifications</p>
                    <p class="text-sm text-gray-500 mt-1 sm:mt-0">Get notified about important updates even when the app is closed.</p>
                </div>
                <button id="enable-notifications-btn"
                    class="w-full sm:w-auto mt-3 sm:mt-0 px-6 py-2 bg-[#3a4d39] text-white text-center font-semibold rounded-lg shadow-sm hover:bg-opacity-90 transition-colors">
                    Enable
                </button>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-sm border border-[#e1e4d5] p-5 sm:p-6">
            <h3 class="text-lg font-bold text-[#3a4d39] border-b border-gray-200 pb-3 mb-4">Account</h3>

            <div class="flex flex-col sm:flex-row items-center justify-between p-3 rounded-lg hover:bg-gray-50 transition-colors">
                <div>
                    <p class="font-semibold text-gray-800">Manage Account</p>
                    <p class="text-sm text-gray-500 mt-1 sm:mt-0">Review and organize your profile and security settings.</p>
                </div>
                <a href="{{ url_for('main.manage_account') }}" 
                    class="w-full sm:w-auto mt-3 sm:mt-0 px-6 py-2 bg-[#3a4d39] text-white text-center font-semibold rounded-lg shadow-sm hover:bg-opacity-90 transition-colors">
                    Edit
                </a>
            </div>
            <div class="border-t flex flex-col sm:flex-row items-center justify-between p-3 rounded-lg hover:bg-gray-50 transition-colors">
                <div>
                    <p class="font-semibold text-gray-800">Log Out</p>
                    <p class="text-sm text-gray-500 mt-1 sm:mt-0">End your current session and return to the login page.</p>
                </div>
                <a href="{{ url_for('auth.logout') }}" 
                    class="w-full sm:w-auto mt-3 sm:mt-0 px-6 py-2 bg-red-600 text-white text-center font-semibold rounded-lg shadow-sm hover:bg-red-700 transition-colors">
                    Log Out
                </a>
            </div>
        </div>
        
    </div>
</main>
{% endblock %}

{% block scripts %}
<!-- --- START OF MODIFICATION: Added script to handle push notification button --- -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const enableNotificationsBtn = document.getElementById('enable-notifications-btn');

    // Helper function to convert VAPID key
    function urlBase64ToUint8Array(base64String) {
        const padding = '='.repeat((4 - base64String.length % 4) % 4);
        const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);
        for (let i = 0; i < rawData.length; ++i) {
            outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray;
    }

    async function subscribeUserToPush() {
        if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
            alert('Push Notifications are not supported by your browser.');
            return;
        }

        try {
            const permission = await Notification.requestPermission();
            if (permission !== 'granted') {
                alert('Notification permission was not granted.');
                return;
            }

            const serviceWorkerRegistration = await navigator.serviceWorker.ready;
            const vapidPublicKey = document.body.dataset.vapidPublicKey;

            if (!vapidPublicKey) {
                console.error('VAPID public key not found.');
                alert('Client-side configuration error for push notifications.');
                return;
            }

            const subscription = await serviceWorkerRegistration.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: urlBase64ToUint8Array(vapidPublicKey)
            });

            // Send the subscription to the backend
            const response = await fetch('/api/save-subscription', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': window.getCSRFToken ? window.getCSRFToken() : ''
                },
                body: JSON.stringify(subscription)
            });

            if (response.ok) {
                alert('Successfully subscribed to push notifications!');
                enableNotificationsBtn.textContent = 'Enabled';
                enableNotificationsBtn.disabled = true;
            } else {
                const errorData = await response.json();
                alert('Failed to save subscription on server: ' + (errorData.error || 'Unknown error'));
            }

        } catch (error) {
            console.error('Failed to subscribe to push notifications:', error);
            alert('An error occurred while trying to subscribe to notifications.');
        }
    }

    if (enableNotificationsBtn) {
        enableNotificationsBtn.addEventListener('click', subscribeUserToPush);
    }
});
</script>
<!-- --- END OF MODIFICATION --- -->
{% endblock %}
