{% extends "base.html" %}
{% block title %}DecoOffice - Schedules{% endblock %}
{% block head %}
<meta name="csrf-token" content="{{ csrf_token() }}">

<!-- --- START OF MODIFICATION --- -->
<style>
    /* --- Layout Base --- */
    html, body {
        height: 100%;
    }

    main {
        display: flex;
        flex-direction: column;
        height: 100%;
        min-height: 100vh;
    }

    .main-content-layout {
        flex: 1;
        display: flex;
        flex-direction: row;
        gap: 1rem;
        min-height: 0;
        height: 100%;
    }

    .calendar-wrapper {
        display: flex;
        flex: 1;
        min-height: 0;
        height: 100%;
    }

    /* --- Main Calendar Container --- */
    .dynamic-calendar-container {
        background-color: #3a4d39;
        color: #ffffff;
        border-radius: 1.5rem;
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        flex: 1;
        min-height: 0;
        height: 100%;
        width: 100%;
        box-sizing: border-box;
        overflow: hidden;
    }

    /* --- Calendar Header --- */
    .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    .calendar-title {
        font-size: 1.5rem;
        font-weight: 700;
        letter-spacing: 0.05em;
    }
    .calendar-nav button {
        background: transparent;
        border: none;
        color: #ffffff;
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0 0.5rem;
    }

    /* --- View Switcher Buttons --- */
    #view-switcher {
        background-color: #f6f7f1;
        border: 1px solid #d4d8c4;
        color: #3a4d39;
    }
    #view-switcher button.active-view {
        background-color: #ffffff;
        color: #3a4d39;
        box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1),
                    0 1px 2px -1px rgb(0 0 0 / 0.1);
    }

    /* --- Calendar Grid --- */
    .calendar-grid {
        display: grid;
        flex: 1;
        gap: 1px;
        background-color: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.2);
        overflow: auto;
        min-height: 0;
    }
    .calendar-grid > div {
        background-color: #3a4d39;
        padding: 0.5rem;
    }

    /* --- Month View --- */
    .month-view {
        grid-template-columns: repeat(7, 1fr);
        grid-template-rows: auto repeat(5, 1fr);
    }
    .month-view .day-header {
        text-align: center;
        font-weight: 600;
        padding: 0.75rem 0.5rem;
    }
    .month-view .date-cell {
        padding: 0.5rem;
    }
    .month-view .date-cell.empty {
        background-color: #3a4d39;
    }
    .month-view .date-number {
        font-weight: 500;
    }
    .month-view .is-today {
        background-color: rgba(255, 255, 255, 0.1);
    }

    /* --- Week View --- */
    .week-view {
        grid-template-columns: 60px repeat(7, 1fr);
    }
    .week-view .day-header {
        text-align: center;
        font-weight: 600;
        padding: 0.75rem 0.5rem;
    }
    .week-view .time-slot {
        font-size: 0.875rem;
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #e5e7eb;
    }

    .event-placeholder {
        position: absolute;
        background-color: #E9D5FF;
        color: #37304A;
        border-radius: 4px;
        padding: 4px 8px;
        font-size: 12px;
        left: 2px;
        right: 2px;
        top: 0;
        height: 120px;
    }
</style>
<!-- --- END OF MODIFICATION --- -->

{% endblock %}

{% block content %}
<main class="flex-1 p-4 flex flex-col bg-[#f6f7f1] text-[#3a4d39]">

    <!-- Header -->
    <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-4">
        <div>
            <h1 class="text-2xl font-bold">Schedules</h1>
        </div>
        <div id="view-switcher" class="bg-gray-200 p-1 rounded-lg text-xs sm:text-sm font-semibold self-start sm:self-center">
            <button data-view="day" class="px-2 sm:px-3 py-1 rounded-md">Day</button>
            <button data-view="week" class="px-2 sm:px-3 py-1 rounded-md active-view">Week</button>
            <button data-view="month" class="px-2 sm:px-3 py-1 rounded-md">Month</button>
            <button data-view="year" class="px-2 sm:px-3 py-1 rounded-md">Year</button>
        </div>
    </header>

    <!-- Main Layout -->
    <div class="main-content-layout">
        <!-- Left Sidebar -->
        <aside class="w-full lg:max-w-xs bg-[#3a4d39] text-white rounded-2xl p-4 flex flex-col space-y-4">
            <button id="create-schedule-btn"
                class="w-full bg-white text-[#3a4d39] font-bold py-2.5 rounded-xl hover:bg-gray-200 transition-colors">
                Create Schedule
            </button>
            <div>
                <div class="flex justify-between items-center mb-2">
                    <span id="mini-cal-title" class="font-bold text-base tracking-wider">OCTOBER 2025</span>
                    <div>
                        <button id="mini-cal-prev" class="px-2 hover:text-gray-300">&lt;</button>
                        <button id="mini-cal-next" class="px-2 hover:text-gray-300">&gt;</button>
                    </div>
                </div>
                <div id="mini-cal-grid" class="grid grid-cols-7 text-center text-sm gap-y-2">
                    <span class="font-medium text-gray-400">S</span>
                    <span class="font-medium text-gray-400">M</span>
                    <span class="font-medium text-gray-400">T</span>
                    <span class="font-medium text-gray-400">W</span>
                    <span class="font-medium text-gray-400">T</span>
                    <span class="font-medium text-gray-400">F</span>
                    <span class="font-medium text-gray-400">S</span>
                </div>
            </div>
            <div id="label-filter">
                <h3 class="font-bold text-base mb-3">Label</h3>
                <div class="space-y-3 text-sm">
                    <div class="flex items-center gap-3"><div class="w-3 h-3 rounded-full" style="background-color: #3b82f6;"></div><span>Office</span></div>
                    <div class="flex items-center gap-3"><div class="w-3 h-3 rounded-full" style="background-color: #8b5cf6;"></div><span>Meetings</span></div>
                    <div class="flex items-center gap-3"><div class="w-3 h-3 rounded-full" style="background-color: #ec4d99;"></div><span>Events</span></div>
                    <div class="flex items-center gap-3"><div class="w-3 h-3 rounded-full" style="background-color: #f59e0b;"></div><span>Personal</span></div>
                    <div class="flex items-center gap-3"><div class="w-3 h-3 rounded-full" style="background-color: #6b7280;"></div><span>Others</span></div>
                </div>
                <button class="w-full mt-4 bg-white/10 text-white font-semibold py-2 rounded-xl text-xs hover:bg-white/20 transition-colors">+ Add Label</button>
            </div>
        </aside>

        <!-- Right: Dynamic Calendar -->
        <div class="calendar-wrapper">
            <div id="main-calendar-container" class="dynamic-calendar-container">
                <!-- Calendar content generated by dynamic_calendar.js -->
            </div>
        </div>
    </div>
</main>

{% include "_create_schedule_modal.html" %}
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/dynamic_calendar.js') }}"></script>
    
<script>
document.addEventListener('DOMContentLoaded', function() {
    const miniCalTitle = document.getElementById('mini-cal-title');
    const miniCalGrid = document.getElementById('mini-cal-grid');
    const prevBtn = document.getElementById('mini-cal-prev');
    const nextBtn = document.getElementById('mini-cal-next');

    if (!miniCalTitle || !miniCalGrid || !prevBtn || !nextBtn) return;

    let currentDate = new Date();
    const monthNames = ["JANUARY", "FEBRUARY", "MARCH", "APRIL", "MAY", "JUNE", "JULY", "AUGUST", "SEPTEMBER", "OCTOBER", "NOVEMBER", "DECEMBER"];

    function renderMiniCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const today = new Date();
        miniCalTitle.textContent = `${monthNames[month]} ${year}`;
        while (miniCalGrid.children.length > 7) miniCalGrid.removeChild(miniCalGrid.lastChild);
        const firstDayOfMonth = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        for (let i = 0; i < firstDayOfMonth; i++) miniCalGrid.insertAdjacentHTML('beforeend', '<span></span>');
        for (let day = 1; day <= daysInMonth; day++) {
            const dayEl = document.createElement('span');
            dayEl.textContent = day;
            dayEl.className = 'py-0.5 px-2 text-white cursor-pointer hover:bg-white/20 rounded-full transition-colors';
            const applySelectedStyle = (el) => {
                el.classList.add('bg-white', 'text-[#3a4d39]', 'font-bold');
                el.classList.remove('text-white');
            };
            const removeSelectedStyle = (el) => {
                el.classList.remove('bg-white', 'text-[#3a4d39]', 'font-bold');
                el.classList.add('text-white');
            };
            if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                applySelectedStyle(dayEl);
            }
            dayEl.addEventListener('click', () => {
                const selectedDate = new Date(year, month, day);
                const currentlySelected = miniCalGrid.querySelector('.bg-white');
                if (currentlySelected) removeSelectedStyle(currentlySelected);
                applySelectedStyle(dayEl);
            });
            miniCalGrid.appendChild(dayEl);
        }
    }
    prevBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderMiniCalendar(); });
    nextBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderMiniCalendar(); });
    function scheduleMidnightRefresh() {
        const now = new Date();
        const midnight = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 0, 0, 0);
        const msUntilMidnight = midnight.getTime() - now.getTime();
        setTimeout(() => { renderMiniCalendar(); scheduleMidnightRefresh(); }, msUntilMidnight + 1000);
    }
    renderMiniCalendar();
    scheduleMidnightRefresh();
});
</script>
{% endblock %}
