{% extends "base.html" %}
{% block title %}DecoOffice - Schedules{% endblock %}
{% block head %}
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/main.min.css' rel='stylesheet' />
<meta name="csrf-token" content="{{ csrf_token() }}">
<style>
    /* --- General Layout & Calendar Container --- */
    #calendar {
        --fc-border-color: #e5e7eb;
        --fc-day-bg-color: transparent;
        --fc-today-bg-color: rgba(111, 138, 110, 0.05);
        height: 100%;
    }

    /* --- FullCalendar Component Styling (Scaled Down) --- */
    .fc .fc-toolbar-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #3a4d39;
    }
    .fc .fc-button {
        font-size: 0.9em;
        padding: 0.4em 0.65em;
    }

    .fc .fc-col-header-cell-cushion, .fc .fc-daygrid-day-number, .fc .fc-timegrid-slot-label-cushion {
        font-size: 0.875rem;
        color: #6b7280;
        text-decoration: none;
    }
    .fc .fc-col-header-cell-cushion {
        font-weight: 600;
        color: #4b5563;
    }
    .fc .fc-timegrid-axis-frame {
        align-items: flex-start;
        padding-top: 4px;
    }

    .fc-event {
        border: none !important;
        background-color: white !important;
        padding: 0.25rem 0.5rem;
        border-radius: 0.5rem;
        box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
    }
    .fc-event-main { color: #374151; font-weight: 600; }
    .event-label-dot {
        width: 8px; height: 8px;
        border-radius: 9999px;
        margin-right: 6px;
        display: inline-block;
    }
</style>
{% endblock %}

{% block content %}
<main class="flex-1 p-4 flex flex-col bg-[#f6f7f1] text-[#3a4d39]">

    <!-- Header -->
    <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-4">
        <div>
            <h1 class="text-2xl font-bold">Schedules</h1>
        </div>
        <div class="bg-gray-200 p-1 rounded-lg text-xs sm:text-sm font-semibold self-start sm:self-center">
            <button id="day-view-btn" class="px-2 sm:px-3 py-1 rounded-md">Day</button>
            <button id="week-view-btn" class="px-2 sm:px-3 py-1 rounded-md bg-white shadow">Week</button>
            <button id="month-view-btn" class="px-2 sm:px-3 py-1 rounded-md">Month</button>
            <button id="year-view-btn" class="px-2 sm:px-3 py-1 rounded-md">Year</button>
        </div>
    </header>

    <!-- Main Layout -->
    <div class="flex-1 flex flex-col lg:flex-row gap-4 min-h-0">

        <!-- Left Sidebar -->
        <aside class="w-full lg:max-w-xs bg-[#3a4d39] text-white rounded-2xl p-4 flex flex-col space-y-4">
            <button id="create-schedule-btn"
                class="w-full bg-white text-[#3a4d39] font-bold py-2.5 rounded-xl hover:bg-gray-200 transition-colors">
                Create Schedule
            </button>

            <!-- Mini Calendar -->
            <div>
                <div class="flex justify-between items-center mb-2">
                    <span id="mini-cal-title" class="font-bold text-base tracking-wider">OCTOBER 2025</span>
                    <div>
                        <button id="mini-cal-prev" class="px-2 hover:text-gray-300">&lt;</button>
                        <button id="mini-cal-next" class="px-2 hover:text-gray-300">&gt;</button>
                    </div>
                </div>
                <div id="mini-cal-grid" class="grid grid-cols-7 text-center text-sm gap-y-2">
                    <span class="font-medium text-gray-400">S</span><span class="font-medium text-gray-400">M</span><span class="font-medium text-gray-400">T</span><span class="font-medium text-gray-400">W</span><span class="font-medium text-gray-400">T</span><span class="font-medium text-gray-400">F</span><span class="font-medium text-gray-400">S</span>
                </div>
            </div>

            <!-- Labels -->
            <div id="label-filter">
                <h3 class="font-bold text-base mb-3">Label</h3>
                <div class="space-y-3 text-sm">
                    <div class="flex items-center gap-3"><div class="w-3 h-3 rounded-full" style="background-color: #3b82f6;"></div><span>Office</span></div>
                    <div class="flex items-center gap-3"><div class="w-3 h-3 rounded-full" style="background-color: #8b5cf6;"></div><span>Meetings</span></div>
                    <div class="flex items-center gap-3"><div class="w-3 h-3 rounded-full" style="background-color: #ec4d99;"></div><span>Events</span></div>
                    <div class="flex items-center gap-3"><div class="w-3 h-3 rounded-full" style="background-color: #f59e0b;"></div><span>Personal</span></div>
                    <div class="flex items-center gap-3"><div class="w-3 h-3 rounded-full" style="background-color: #6b7280;"></div><span>Others</span></div>
                </div>
                <button class="w-full mt-4 bg-white/10 text-white font-semibold py-2 rounded-xl text-xs hover:bg-white/20 transition-colors">+ Add Label</button>
            </div>
        </aside>

        <!-- Right: Calendar -->
        <div class="flex-1 flex h-full">
            <div id='calendar' class="bg-white rounded-2xl p-4 flex-1"></div>
        </div>
    </div>
</main>

{% include "_create_schedule_modal.html" %}
{% endblock %}

{% block scripts %}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/main.min.js'></script>
<script src="{{ url_for('static', filename='js/calendar.js') }}"></script>
    
<script>
document.addEventListener('DOMContentLoaded', function() {
    const miniCalTitle = document.getElementById('mini-cal-title');
    const miniCalGrid = document.getElementById('mini-cal-grid');
    const prevBtn = document.getElementById('mini-cal-prev');
    const nextBtn = document.getElementById('mini-cal-next');
    const mainCalendar = window.calendar; 

    if (!miniCalTitle || !miniCalGrid || !prevBtn || !nextBtn) return;

    let currentDate = new Date();
    const monthNames = ["JANUARY", "FEBRUARY", "MARCH", "APRIL", "MAY", "JUNE", "JULY", "AUGUST", "SEPTEMBER", "OCTOBER", "NOVEMBER", "DECEMBER"];

    function renderMiniCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const today = new Date(); // Get the latest date every time we render

        miniCalTitle.textContent = `${monthNames[month]} ${year}`;
        while (miniCalGrid.children.length > 7) miniCalGrid.removeChild(miniCalGrid.lastChild);

        const firstDayOfMonth = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        for (let i = 0; i < firstDayOfMonth; i++) miniCalGrid.insertAdjacentHTML('beforeend', '<span></span>');

        for (let day = 1; day <= daysInMonth; day++) {
            const dayEl = document.createElement('span');
            dayEl.textContent = day;
            dayEl.className = 'py-0.5 px-2 text-white cursor-pointer hover:bg-white/20 rounded-full transition-colors';

            const applySelectedStyle = (el) => {
                el.classList.add('bg-white', 'text-[#3a4d39]', 'font-bold');
                el.classList.remove('text-white');
            };
            const removeSelectedStyle = (el) => {
                el.classList.remove('bg-white', 'text-[#3a4d39]', 'font-bold');
                el.classList.add('text-white');
            };

            // This condition now correctly re-evaluates 'today' on every render
            if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                applySelectedStyle(dayEl);
            }

            dayEl.addEventListener('click', () => {
                const selectedDate = new Date(year, month, day);
                if (mainCalendar) mainCalendar.gotoDate(selectedDate);
                
                const currentlySelected = miniCalGrid.querySelector('.bg-white');
                if (currentlySelected) removeSelectedStyle(currentlySelected);
                
                applySelectedStyle(dayEl);
            });

            miniCalGrid.appendChild(dayEl);
        }
    }

    prevBtn.addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderMiniCalendar();
    });

    nextBtn.addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderMiniCalendar();
    });
    
    // --- NEW: Function to handle auto-updating at midnight ---
    function scheduleMidnightRefresh() {
        const now = new Date();
        const midnight = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 0, 0, 0);
        const msUntilMidnight = midnight.getTime() - now.getTime();

        setTimeout(() => {
            // Rerender the calendar to update the 'today' highlight
            renderMiniCalendar();
            // Schedule the next refresh for the *next* midnight
            scheduleMidnightRefresh();
        }, msUntilMidnight + 1000); // Add a 1-second buffer
    }

    // Initial render and schedule the first midnight refresh
    renderMiniCalendar();
    scheduleMidnightRefresh();
});
</script>
{% endblock %}